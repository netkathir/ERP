name: Deploy to Web Server

on:
  push:
    branches:
      - main  # Trigger deployment on pushes to the `main` branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Upload files to FTP server
        run: |
          python - <<EOF
          import os
          from ftplib import FTP, error_perm

          # FTP details (use secrets)
          ftp_host = "${{ secrets.FTP_SERVER }}"
          ftp_user = "${{ secrets.FTP_USERNAME }}"
          ftp_passwd = "${{ secrets.FTP_PASSWORD }}"

          # Connect to FTP server
          ftp = FTP(ftp_host)
          ftp.login(ftp_user, ftp_passwd)

          # Local and remote directories
          local_dir = './'  # Path to your code (use `./` for the whole repo)
          remote_dir = '/public_html/custom_erp/'  # Remote directory

          # Function to create remote directory if it doesn't exist
          def create_directory_if_not_exists(remote_path):
              try:
                  # Try changing to the remote directory
                  ftp.cwd(remote_path)
              except error_perm as e:
                  # If directory doesn't exist, create it
                  if '550' in str(e):
                      print(f"Directory {remote_path} does not exist. Creating it.")
                      ftp.mkd(remote_path)
                      ftp.cwd(remote_path)
                  else:
                      raise

          # Create remote directory if it doesn't exist
          create_directory_if_not_exists(remote_dir)

          # Function to upload files
          def upload_file(file_path):
              with open(file_path, 'rb') as f:
                  ftp.storbinary('STOR ' + os.path.basename(file_path), f)

          # Upload all files in the local directory
          for root, dirs, files in os.walk(local_dir):
              for file in files:
                  local_file = os.path.join(root, file)
                  upload_file(local_file)

          # Close the FTP connection
          ftp.quit()
          EOF
